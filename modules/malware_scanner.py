import os
import threading
import tkinter as tk
from tkinter import filedialog, messagebox
import ttkbootstrap as ttkB
import pyclamd
import main


# Define the MalwareScanner class
class MalwareScanner:
    def __init__(self, gui):
        try:
            self.clamd = pyclamd.ClamdAgnostic()
        except Exception as e:
            messagebox.showerror("Connection Error", f"Could not connect to ClamAV: {str(e)}")
            exit()

        self.stop_flag = threading.Event()
        self.gui = gui

    # Function to scan a file using ClamAV
    def scan_file(self, file_path):
        if self.stop_flag.is_set():
            return
        
        result = self.clamd.scan_file(file_path)
        if result and file_path in result:
            scan_result, scan_info = result[file_path]
            if scan_result == 'FOUND':
                message = f"Malware found in file: {file_path}\nType: {scan_info}"
            else:
                message = f"No malware found in file: {file_path}"
            self.gui.update_info(message)

    # Function to scan a directory
    def scan_directory(self, directory_path):
        for root, dirs, files in os.walk(directory_path):
            for file_name in files:
                # Check if stop_flag is set
                if self.stop_flag.is_set():
                    self.gui.update_info("Scan stopped.")
                    return
                
                file_path = os.path.join(root, file_name)
                self.scan_file(file_path)

    # Function to perform a full system scan
    def full_scan(self):
        root_path = os.path.abspath('/')
        self.scan_directory(root_path)

    # Function to stop the scanning process
    def stop_scan(self):
        self.stop_flag.set()
        self.gui.update_info("Stopping the scan...")

# Define the GUI class for the malware scanner
class MalwareScannerGUI:
    def __init__(self):
        self.root = ttkB.Window(themename='superhero')
        self.scanner = MalwareScanner(self)
        self.setup_gui()
        
    def setup_gui(self):
        self.root.title("Malware Scanner")
        self.root.geometry('600x200')
        self.root.maxsize(height=305, width=900)
        self.root.minsize(height=305, width=900)

        display = ttkB.Label(self.root, text='Scan for Malware', font='bold 15')
        display.place(x=120, y=10)

        choose_button = ttkB.Button(self.root, text="Scan Directory", command=self.choose_directory, style='outline.info')
        choose_button.place(x=50, y=50,height=100, width=150)

        full_scan_button = ttkB.Button(self.root, text="Full Scan", command=self.full_scan, style='outline.success')
        full_scan_button.place(x=225, y=50, height=100, width=150)

        stop_scan_button = ttkB.Button(self.root, text="Stop Scan", command=self.scanner.stop_scan, style='outline.danger')
        stop_scan_button.place(x=50, y=175, height=100, width=150)

        self.process_info_text = tk.Text(self.root, wrap="word", height=11.5, width=50, foreground='green', border=5, fg='green')
        self.process_info_text.place(x=400, y=50)

        # Exit button
        exit_button = ttkB.Button(self.root, text='Exit', underline=0, style='danger.Outline.TButton', command=self.root.quit)
        exit_button.place(x=225, y=175, height=100, width=150)

        self.root.mainloop()

    def choose_directory(self):
        directory_path = filedialog.askdirectory()
        if directory_path:
            self.scanner.stop_flag.clear()
            threading.Thread(target=self.scanner.scan_directory, args=(directory_path,)).start()

    def full_scan(self):
        self.scanner.stop_flag.clear()
        threading.Thread(target=self.scanner.full_scan).start()

    def update_info(self, message):
        self.process_info_text.insert(tk.END, message + "\n")
        self.process_info_text.see(tk.END)

def app():
    
    gui = MalwareScannerGUI()

if __name__ == "__main__":
    app()
    # Start the App function in a separate thread with daemon=True
    #app_instance = main.Cyperfx()
    #app_thread = threading.Thread(target=app_instance.App)
    #app_thread.daemon = True
    #app_thread.start()
